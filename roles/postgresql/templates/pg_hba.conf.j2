# PostgreSQL Client Authentication Configuration File
# Generated by Ansible PostgreSQL Role for Trackify Project

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     peer

# IPv4 local connections:
host    all             all             127.0.0.1/32            {{ postgresql_password_encryption }}

{% for network in postgresql_internal_networks %}
# Allow connections from internal network: {{ network }}
host    all             all             {{ network }}           {{ postgresql_password_encryption }}
{% endfor %}

{% for network in postgresql_dmz_networks %}
# Allow application connections from DMZ network: {{ network }}
{% for db in postgresql_databases %}
{% for user in postgresql_users %}
{% if user.db is defined and db.name is defined and user.db == db.name %}
host    {{ db.name }}    {{ user.name }}    {{ network }}        {{ postgresql_password_encryption }}
{% endif %}
{% endfor %}
{% endfor %}
{% endfor %}

# Allow replication connections from backup servers
{% for network in postgresql_internal_networks %}
host    replication     postgres        {{ network }}           {{ postgresql_password_encryption }}
{% endfor %}

{% if postgresql_monitoring_enabled %}
# Monitoring user for PostgreSQL Exporter
host    postgres        {{ postgresql_exporter_user }}    127.0.0.1/32       {{ postgresql_password_encryption }}
{% set monitoring_host = '192.168.1.25' %}
{% if groups is defined and 'monitoring' in groups and groups['monitoring']|length > 0 %}
{% set monitoring_host = hostvars[groups['monitoring'][0]]['ansible_host'] | default('192.168.1.25') %}
{% endif %}
host    postgres        {{ postgresql_exporter_user }}    {{ monitoring_host }}/32    {{ postgresql_password_encryption }}
{% endif %}
