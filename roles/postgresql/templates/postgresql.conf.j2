#------------------------------------------------------------------------------
# POSTGRESQL CONFIGURATION FILE
# Generated by Ansible PostgreSQL Role for Trackify Project
#------------------------------------------------------------------------------

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------
data_directory = '{{ postgresql_data_dir }}'
hba_file = '{{ postgresql_config_dir }}/pg_hba.conf'
ident_file = '{{ postgresql_config_dir }}/pg_ident.conf'

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------
listen_addresses = '{{ postgresql_listen_addresses }}'
port = {{ postgresql_port }}
max_connections = {{ postgresql_max_connections }}
superuser_reserved_connections = 3

# Authentication
authentication_timeout = 1min
password_encryption = {{ postgresql_password_encryption }}

{% if postgresql_ssl %}
#------------------------------------------------------------------------------
# SSL
#------------------------------------------------------------------------------
ssl = on
ssl_cert_file = '{{ postgresql_ssl_cert_file }}'
ssl_key_file = '{{ postgresql_ssl_key_file }}'
{% if postgresql_ssl_ca_file %}
ssl_ca_file = '{{ postgresql_ssl_ca_file }}'
{% endif %}
{% endif %}

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------
shared_buffers = {{ postgresql_shared_buffers }}
huge_pages = try
work_mem = {{ postgresql_work_mem }}
maintenance_work_mem = {{ postgresql_maintenance_work_mem }}
effective_cache_size = {{ postgresql_effective_cache_size }}
max_worker_processes = 8
max_parallel_workers_per_gather = 2
max_parallel_workers = 8

#------------------------------------------------------------------------------
# WRITE AHEAD LOG
#------------------------------------------------------------------------------
wal_level = replica
wal_buffers = {{ postgresql_wal_buffers }}
max_wal_size = {{ postgresql_max_wal_size }}
min_wal_size = {{ postgresql_min_wal_size }}
checkpoint_completion_target = {{ postgresql_checkpoint_completion_target }}
checkpoint_timeout = {{ postgresql_checkpoint_timeout }}

#------------------------------------------------------------------------------
# REPLICATION
#------------------------------------------------------------------------------
max_wal_senders = 10
wal_keep_size = 0
max_slot_wal_keep_size = -1

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------
random_page_cost = {{ postgresql_random_page_cost }}
effective_io_concurrency = {{ postgresql_effective_io_concurrency }}

#------------------------------------------------------------------------------
# ERROR REPORTING AND LOGGING
#------------------------------------------------------------------------------
log_destination = '{{ postgresql_log_destination }}'
logging_collector = {{ postgresql_logging_collector | lower }}
log_directory = '{{ postgresql_log_dir }}'
log_filename = '{{ postgresql_log_filename }}'
log_file_mode = 0600
log_truncate_on_rotation = off
log_rotation_age = {{ postgresql_log_rotation_age }}
log_rotation_size = {{ postgresql_log_rotation_size }}

# What to log
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = {{ postgresql_log_min_duration_statement }}
log_line_prefix = '{{ postgresql_log_line_prefix }}'
log_lock_waits = {{ postgresql_log_lock_waits | lower }}
log_statement = '{{ postgresql_log_statement }}'
log_temp_files = {{ postgresql_log_temp_files }}

#------------------------------------------------------------------------------
# RUNTIME STATISTICS
#------------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl
stats_temp_directory = 'pg_stat_tmp'

#------------------------------------------------------------------------------
# AUTOVACUUM PARAMETERS
#------------------------------------------------------------------------------
autovacuum = {{ postgresql_autovacuum | lower }}
{% if postgresql_autovacuum %}
log_autovacuum_min_duration = 0
autovacuum_max_workers = {{ postgresql_autovacuum_max_workers }}
autovacuum_naptime = {{ postgresql_autovacuum_naptime }}
autovacuum_vacuum_threshold = {{ postgresql_autovacuum_vacuum_threshold }}
autovacuum_vacuum_scale_factor = {{ postgresql_autovacuum_vacuum_scale_factor }}
autovacuum_analyze_threshold = {{ postgresql_autovacuum_analyze_threshold }}
autovacuum_analyze_scale_factor = {{ postgresql_autovacuum_analyze_scale_factor }}
{% endif %}

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------
search_path = '"$user", public'
default_tablespace = ''
temp_tablespaces = ''
default_toast_compression = 'pglz'

# Locale and Formatting
datestyle = 'iso, mdy'
timezone = 'Europe/Zurich'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 64
max_pred_locks_per_transaction = 64

#------------------------------------------------------------------------------
# VERSION/PLATFORM COMPATIBILITY
#------------------------------------------------------------------------------
shared_preload_libraries = 'pg_stat_statements'
